# ステータス機能の挙動整理と総合成績表示の拡張

## 📋 変更概要

### 1. 列順の変更
**ステータス設定画面の列順を変更しました。**

**変更前:**
```
[ゼッケン] [区間1] ... [区間N] [Total Result] [ペナルティ]
```

**変更後:**
```
[ゼッケン] [区間1] ... [区間N] [ペナルティ] [Total Result]
```

### 2. Total Resultステータスの挙動変更

**変更前:**
- Total Result にステータス（RIT/N.C./BLNK）を設定すると総合得点が0になる

**変更後:**
- Total Result にステータスを設定しても得点は計算して表示される
- 順位付けからのみ除外される
- 得点は表示されるが、順位の代わりにステータス（RIT/N.C./BLNK）が表示される

### 3. 総合成績表示の拡張

**追加された列:**
- DriverName
- CoDriverName
- CarName
- 車両製造年
- CarClass
- Point (純粋な得点)
- H.C.L Point
- Penalty(-) (赤字表記)
- TotalPoint

---

## 🎯 区間ステータスとTotal Resultステータスの整理

### 区間ステータス（RIT/N.C./BLNK）

**対象範囲:**
- 特定の区間のみ

**設定方法:**
- ステータス設定画面の区間列にステータスを設定

**効果:**

1. **その区間の得点:**
   - 0になる

2. **その区間の順位:**
   - 順位付けから除外される
   - 順位欄にステータス（RIT/N.C./BLNK）が表示される

3. **総合得点への影響:**
   - その区間の得点が0なので、総合得点は減少する
   - 例: PC1でRIT → PC1の得点が0 → 総合得点は PC1を除く得点の合計

4. **総合順位:**
   - 総合得点が減少するため、順位は下がる可能性がある
   - ただし、順位付けからは除外されない（Total Resultにステータスがない限り）

**使用例:**
```
シナリオ: ゼッケン5がPC2でリタイヤした

設定:
- PC2列に "RIT" を設定

結果:
- PC2の得点: 0
- PC2の順位: RIT と表示
- 総合得点: PC1 + PC3 + ... + CO（PC2は含まれない）
- 総合順位: 通常通り順位付けされる
```

### Total Resultステータス（RIT/N.C./BLNK）

**対象範囲:**
- 最終結果（総合順位）全体

**設定方法:**
- ステータス設定画面の Total Result 列にステータスを設定

**効果:**

1. **各区間の得点:**
   - 影響なし（通常通り計算される）

2. **各区間の順位:**
   - 影響なし（通常通り順位付けされる）

3. **総合得点:**
   - **変更後**: 通常通り計算されて表示される
   - 係数、年齢係数も適用される
   - ペナルティも引かれる

4. **総合順位:**
   - 順位付けから除外される
   - 順位の代わりにステータス（RIT/N.C./BLNK）が表示される
   - 他のゼッケンの順位には影響しない（除外されたゼッケンは順位にカウントされない）

**使用例:**
```
シナリオ: ゼッケン10が最終的にリタイヤ扱いになった

設定:
- Total Result列に "RIT" を設定

結果:
- 各区間の得点: 通常通り計算される
- 各区間の順位: 通常通り表示される
- 総合得点: (PC+PCG)*係数*年齢係数+CO-ペナルティ で計算されて表示
- 総合順位: 順位の代わりに "RIT" と表示される
```

### 両方設定した場合

**シナリオ: PC2で区間リタイヤ + 最終的にもリタイヤ扱い**

```
設定:
- PC2列に "RIT" を設定
- Total Result列に "RIT" を設定

結果:
- PC2の得点: 0
- PC2の順位: RIT
- 総合得点: PC1 + PC3 + ... + CO（PC2は0） - ペナルティ
- 総合順位: RIT と表示（順位付けから除外）
```

---

## 📊 総合成績表示の詳細

### 新しい列構成

| 列名 | 説明 | データソース | 備考 |
|------|------|------------|------|
| Result | 順位 | 総合得点から計算 | RIT/N.C./BLNKの場合はステータス表示 |
| No | ゼッケン番号 | entries | - |
| DriverName | ドライバー名 | entries | - |
| CoDriverName | コドライバー名 | entries | - |
| CarName | 車名 | entries | - |
| 車両製造年 | 車両製造年 | entries | - |
| CarClass | 車両クラス | entries | - |
| Point | 純粋な得点 | 計算 | PC + PCG + CO（係数なし） |
| H.C.L Point | H.C.L.得点 | 計算 | (PC+PCG)*係数*年齢係数+CO |
| Penalty(-) | ペナルティ | app_config | 赤字表記、正数 |
| TotalPoint | 最終得点 | 計算 | H.C.L Point - Penalty |

### 計算式

**Point (純粋な得点):**
```
Point = PC区間の得点合計 + PCG区間の得点合計 + CO区間の得点合計
```

**H.C.L Point:**
```
H.C.L Point = (PC + PCG) * 係数 * 年齢係数 + CO
```

**TotalPoint:**
```
TotalPoint = H.C.L Point - Penalty
```

### 順位付けのロジック

**順位付けの基準:**
- H.C.L Point で降順ソート
- Total Result ステータスがあるゼッケンは除外
- 除外されたゼッケンの順位欄には RIT/N.C./BLNK が表示される

**例:**

| Result | No | H.C.L Point | Penalty(-) | TotalPoint | 備考 |
|--------|----|-----------:|----------:|-----------:|------|
| 1 | 3 | 1500 | 0 | 1500 | 1位 |
| 2 | 7 | 1400 | 0 | 1400 | 2位 |
| 3 | 12 | 1350 | 100 | 1250 | 3位（ペナルティあり） |
| RIT | 5 | 800 | 0 | 800 | Total Resultステータスあり |
| N.C. | 10 | 950 | 50 | 900 | Total Resultステータスあり |

---

## 💡 使用例

### 例1: 通常の完走

```
設定:
- 区間ステータス: なし
- Total Result: なし
- ペナルティ: 0

結果:
Result: 5位（H.C.L Pointで順位付け）
Point: 850
H.C.L Point: 1200
Penalty(-): （空白）
TotalPoint: 1200
```

### 例2: ペナルティあり

```
設定:
- 区間ステータス: なし
- Total Result: なし
- ペナルティ: 100

結果:
Result: 8位（H.C.L Pointで順位付け）
Point: 900
H.C.L Point: 1300
Penalty(-): 100（赤字）
TotalPoint: 1200
```

### 例3: PC2でリタイヤ、最終結果は通常

```
設定:
- PC2に "RIT" 設定
- Total Result: なし
- ペナルティ: 0

結果:
Result: 12位（他の区間の得点で順位付け）
Point: 600（PC2が0なので減少）
H.C.L Point: 850
Penalty(-): （空白）
TotalPoint: 850
```

### 例4: 通常走行したが、最終的にRIT扱い

```
設定:
- 区間ステータス: なし
- Total Result: "RIT"
- ペナルティ: 0

結果:
Result: RIT（順位付けから除外）
Point: 900
H.C.L Point: 1300
Penalty(-): （空白）
TotalPoint: 1300
```

### 例5: PC2でリタイヤ + 最終的にもRIT + ペナルティ

```
設定:
- PC2に "RIT" 設定
- Total Result: "RIT"
- ペナルティ: 50

結果:
Result: RIT（順位付けから除外）
Point: 600（PC2が0）
H.C.L Point: 850
Penalty(-): 50（赤字）
TotalPoint: 800
```

---

## 🎨 UI表示の特徴

### ステータス設定画面

**列順:**
```
[ゼッケン] [区間1] ... [区間N] [ペナルティ] [Total Result]
            ↓                      ↓             ↓
         ステータス入力           数字入力    ステータス入力
```

**視覚的な区別:**
- ペナルティ列: 淡い黄色の背景
- Total Result列: 白背景（他の区間列と同じ）

### 総合成績表

**Result列:**
- 1位: 金色の背景
- 2位: 銀色の背景
- 3位: 銅色の背景
- RIT/N.C./BLNK: 通常の背景、ステータス文字列を表示

**Penalty(-) 列:**
- ペナルティがある場合: 赤字で表示
- ペナルティがない場合: 空白

---

## 📝 まとめ

### 重要なポイント

1. **区間ステータス**: 特定の区間の得点を0にする
2. **Total Resultステータス**: 得点は表示、順位付けから除外
3. **ペナルティ**: H.C.L Pointから引かれる、赤字表記
4. **順位付け**: H.C.L Pointで決定（Total Resultステータスがあるものは除外）

### 用語の定義

- **Point**: 純粋な得点（係数なし）
- **H.C.L Point**: Handicap & Class Point（係数・年齢係数適用後）
- **TotalPoint**: 最終得点（ペナルティ減点後）
- **Result**: 順位またはステータス

---

**更新日**: 2026年2月17日  
**バージョン**: v4.0  
**互換性**: 既存の設定ファイルとの完全互換
