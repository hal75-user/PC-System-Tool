# エラー判定ロジック - 要約

## 質問への回答

### Q1: ゼッケン通過順エラーが多すぎる理由は？

#### 現在のエラー判定ロジック

**実装場所**: `data_validator.py` の `check_zekken_passage_order()` 関数

**判定条件**:
```python
# 1. 各ゼッケンについて個別に判定
# 2. グループごとに判定
# 3. 通過区間が2つ以上の場合のみチェック
if len(passed_sections) < 2:
    continue  # 1つ以下ならスキップ

# 4. 期待される順序と実際の通過順序を比較
expected_passed = [s for s in expected_order if s in passed_sections]
if passed_sections != expected_passed:
    # エラー！
```

#### エラーが多くなる原因

1. **全ゼッケンを個別に判定**
   - 100台のゼッケン → 最大100個のエラーが発生可能

2. **厳格な順序チェック**
   - 期待される順序と完全一致を要求
   - 1つでも順序が違えばエラー

3. **エラーとなる具体例**:
   ```
   期待: PC1 → PC2 → PC3 → PC4
   実際: PC1 → PC2 → PC4 → PC3
   → PC3とPC4が逆転 → エラー！
   ```

4. **エラーにならない例**:
   ```
   期待: PC1 → PC2 → PC3 → PC4
   実際: PC1 → PC3 → PC4
   → PC2をスキップしたが順序は正しい → OK
   
   実際: PC1
   → 1つしか通過していない → スキップ（エラーなし）
   ```

#### 対処方法

このエラーは確認可能（`allow_confirmation=True`）なので：

1. **エラー確認ウィンドウで確認**
   - 「⚠️ エラーあり」ボタンをクリック
   - 各エラーを確認

2. **正当なエラーの場合**
   - CSVファイルを修正
   - Race読み込みをやり直し

3. **データが正しい場合**
   - 「確認済み」にする
   - 未確認エラーのカウントから除外される

4. **確認済みステータスの保持**
   - アプリ起動中は保持される
   - 再読み込みしても同じエラーなら復元される

---

## 全エラー一覧（7種類）

### 1. CSVファイル名重複（csv_duplicate）
- **判定**: 同じ区間名が複数のCSVファイルに存在
- **確認可否**: **不可**（必ず修正）
- **例**: `PC3GOAL.csv`と`PC3GOAL_PC4START.csv`が共存

### 2. ゼッケン重複（zekken_duplicate）
- **判定**: 同じ区間で同じゼッケンが2回以上出現
- **確認可否**: **不可**（必ず修正）
- **例**: PC1区間でゼッケン5が2行ある

### 3. 区間通過順（section_order）
- **判定**: グループ内の区間で通過順序が不一致
- **確認可否**: **可**
- **詳細**: 基準区間（グループの最初の区間）と他の区間を比較

### 4. ゼッケン通過順（zekken_order） ← **エラーが多いのはコレ**
- **判定**: ゼッケンがグループ内の区間を正しい順序で通過していない
- **確認可否**: **可**
- **詳細**: 2つ以上の区間を通過したすべてのゼッケンを個別にチェック

### 5. ステータス不正（invalid_status）
- **判定**: RIT/BLNKステータスなのに走行データ（時刻）がある
- **確認可否**: **可**
- **例**: ゼッケン8がRITなのにSTART時刻とGOAL時刻がある

### 6. 計測タイプ確認（measurement_type）
- **判定**: type=T（手動計測）の行にゼッケンが入力されている
- **確認可否**: **可**
- **例**: 手動計測の時刻にゼッケン15が入力されている

### 7. 計測データ不備（measurement_deficiency）
- **判定**: 
  - PC: 半数以上が1秒以上ずれている
  - CO: 半数以上が得点0
- **確認可否**: **可**
- **タイミング**: **計算実行後**のみ

---

## エラーチェックの実行順序

### Race読み込み時
```
1. CSVファイル名重複
2. ゼッケン重複
3. 区間通過順
4. ゼッケン通過順  ← ここで多数のエラーが発生
5. ステータス不正
6. 計測タイプ確認
```

### 計算実行後
```
上記1～6に加えて:
7. 計測データ不備（calc_engineが必要）
```

---

## エラー対処の優先順位

### 【最優先】必ず修正（確認不可）
1. CSVファイル名重複
2. ゼッケン重複

### 【高】確認が必要
3. ステータス不正

### 【中】警告的なもの
4. 計測タイプ確認
5. 計測データ不備

### 【低】確認後に判断
6. 区間通過順
7. ゼッケン通過順

---

## 同一エラー判定（確認済みステータスの復元）

各エラータイプごとに一意のキーを生成：

| エラータイプ | 比較キー |
|---|---|
| CSVファイル名重複 | 区間名 |
| ゼッケン重複 | 区間 + ゼッケン |
| 区間通過順 | グループ + 基準区間 |
| ゼッケン通過順 | ゼッケン + グループ |
| ステータス不正 | 区間 + ゼッケン + ステータス |
| 計測タイプ確認 | 区間 + 時刻 + ゼッケン |
| 計測データ不備 | 区間 |

データを再読み込みしても、同じキーのエラーなら確認済みステータスが復元されます。

---

## UI表示

### メイン画面
- **緑ボタン**: ✓ エラーなし（確認済み: X件）
- **赤ボタン**: ⚠️ エラーあり（未確認: X/Y）

### エラー確認ウィンドウ
- ステータス列: 🔴未確認 / 🟢確認済み
- エラー種別列: 日本語名
- 詳細列: エラーメッセージ全文

### 操作
- 「選択したエラーを確認済みにする」
- 「すべて確認済みにする」（重大エラーは除外）
- 「選択したエラーを未確認に戻す」

---

## ベストプラクティス

### 1. エラー発生時
```
Race読み込み
  ↓
赤ボタン表示「⚠️ エラーあり（未確認: 500/600）」
  ↓
ボタンをクリック
  ↓
エラー確認ウィンドウで確認
  ↓
重大エラー（必ず修正）を修正
  ↓
他のエラーは確認して「確認済み」にする
  ↓
未確認エラーが0になる
  ↓
緑ボタンに変わる
  ↓
計算実行
```

### 2. ゼッケン通過順エラーが多い場合
```
1. 重大エラーがないか確認
   → CSVファイル名重複、ゼッケン重複を優先修正

2. ゼッケン通過順エラーを確認
   → データが正しいなら「すべて確認済みにする」

3. 疑わしいエラーは個別に確認
   → CSVファイルを開いて実際のデータを確認

4. 計算実行
   → 未確認エラーがあっても計算可能（警告が出る）
```

### 3. 効率的な作業フロー
```
1. Race読み込み
2. 重大エラー（確認不可）を修正
3. エラー確認ウィンドウで「すべて確認済みにする」
4. 個別に確認が必要なエラーを確認
5. 計算実行
6. 計測データ不備エラーを確認
7. 必要に応じて修正して再計算
```

---

## 参考資料

詳細な説明は以下のドキュメントを参照してください：

- **全エラー判定条件_詳細説明.md** - 全エラーの詳細なロジック説明
- **ERROR_HANDLING_GUIDE.md** - エラーハンドリング機能ガイド
- **DATA_VALIDATION_GUIDE.md** - データ検証機能ガイド
- **data_validator.py** - 実装コード
