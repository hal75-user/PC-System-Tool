# エラーハンドリング機能実装ガイド

## 概要

このドキュメントは、PC System Tool に追加された新しいエラーハンドリング機能について説明します。

## 新機能

### 1. 新しいエラーチェック

#### 1.1 計測タイプ確認
- **目的**: 手動計測（type=T）の時刻にゼッケンが入力されている場合に警告
- **チェック内容**: CSVファイルのtype列がTの行でnumber列にゼッケン番号が入力されている場合
- **エラータイプ**: `measurement_type`
- **確認許可**: 可能
- **同一エラー判定**: Tの時刻とゼッケンが同じ場合のみ

#### 1.2 計測データ不備確認
- **目的**: 計測データに異常がないかチェック
- **チェック内容**:
  - PC競技: その区間の総通過台数の半数以上が1秒以上ずれている
  - CO競技: その区間の総通過台数の半数以上が得点を取得できていない
  - PCG競技: チェック不要
- **エラータイプ**: `measurement_deficiency`
- **確認許可**: 可能
- **同一エラー判定**: 区間が同じ場合のみ
- **注意**: このチェックは計算実行後に行われます

### 2. エラー表示方法の変更

#### 2.1 メイン画面
- 従来: エラーメッセージを画面上部に表示
- 新方式: 「エラーなし」または「⚠️ エラーあり（未確認: X/Y）」ボタンを表示
  - 緑色: エラーなし、またはすべて確認済み
  - 赤色: 未確認のエラーあり
  - ボタンをクリックするとエラー確認ウィンドウが開く

#### 2.2 エラー確認ウィンドウ
新しいダイアログウィンドウで、以下の機能を提供:

1. **エラー一覧表示**
   - ステータス列: 確認済み（緑）/ 未確認（赤）
   - エラー種別列: エラータイプ
   - 詳細列: エラーメッセージ

2. **操作ボタン**
   - 「選択したエラーを確認済みにする」: 選択したエラーを確認済みにする
   - 「すべて確認済みにする」: 確認可能なすべてのエラーを確認済みにする
   - 「選択したエラーを未確認に戻す」: 確認済みエラーを未確認に戻す
   - 「閉じる」: ウィンドウを閉じる

### 3. エラーステータス管理

#### 3.1 確認済みステータス
- 各エラーは「未確認」または「確認済み」のステータスを持つ
- 確認済みエラーは未確認エラーのカウントに含まれない
- アプリ起動中はステータスが保持される（再起動でリセット）

#### 3.2 同一エラーの判定
エラーが再度検出された際、以前の確認済みステータスを引き継ぐための判定基準:

1. **CSVファイル名重複**: 区間名が同じ
2. **ゼッケン重複**: 区間とゼッケンが同じ
3. **区間通過順**: 最初の区間の基準順番と異なっている区間とその順番が同じ
4. **ゼッケン通過順**: 順番通りに通過していないゼッケンとその通過順番が同じ
5. **ステータス不正**: 走行している区間とゼッケンとステータスが同じ
6. **計測タイプ**: Tの時刻とゼッケンが同じ
7. **計測データ不備**: 区間が同じ

### 4. 確認不可能なエラー

以下のエラーは重大な問題のため、確認済みにすることができません:

1. **CSVファイル名重複**: ファイル名の修正が必須
2. **ゼッケン重複**: CSVファイルの修正が必須

これらのエラーを確認済みにしようとすると、警告が表示されます。

## 使用方法

### エラー確認ワークフロー

1. **Race読み込み**
   - データ検証が自動実行される
   - エラーが検出されると画面上部にボタンが表示される

2. **エラー確認**
   - 「⚠️ エラーあり」ボタンをクリック
   - エラー確認ウィンドウが開く
   - 各エラーを確認し、問題がなければ「確認済み」にする

3. **計算実行**
   - 未確認エラーがある場合、警告が表示される
   - 続行するか選択できる
   - 計算後、計測データ不備チェックが実行される

4. **再検証**
   - データを修正して再読み込みすると、同一エラーの確認済みステータスが復元される

### ベストプラクティス

1. **エラーの優先順位**
   - CSVファイル名重複、ゼッケン重複は最優先で修正
   - 計測タイプエラーは手動計測の確認が必要
   - その他のエラーはデータの妥当性を確認

2. **確認済みの使い方**
   - データが正常であることを確認した場合のみ確認済みにする
   - 確認済みエラーも表示されるため、後から再確認可能
   - 疑わしい場合は未確認のままにする

3. **計算前のチェック**
   - 重大エラー（確認不可）がある場合は計算前に修正
   - 未確認エラーが多数ある場合は確認してから計算

## 技術詳細

### ValidationError クラス

```python
class ValidationError:
    def __init__(self, error_type: str, message: str, 
                 details: Dict = None, allow_confirmation: bool = True):
        self.error_type = error_type
        self.message = message
        self.details = details
        self.allow_confirmation = allow_confirmation
        self.confirmed = False
    
    def get_comparison_key(self) -> str:
        """同一エラー判定用のキーを生成"""
        # エラータイプと詳細から一意のキーを生成
```

### エラータイプ一覧

| エラータイプ | 日本語名 | 確認可否 | 実装関数 |
|---|---|---|---|
| csv_duplicate | CSVファイル名重複 | 不可 | check_duplicate_filenames |
| zekken_duplicate | ゼッケン重複 | 不可 | check_duplicate_zekken_in_section |
| section_order | 区間通過順 | 可 | check_section_passage_order |
| zekken_order | ゼッケン通過順 | 可 | check_zekken_passage_order |
| invalid_status | ステータス不正 | 可 | check_invalid_status_with_time |
| measurement_type | 計測タイプ | 可 | check_measurement_type |
| measurement_deficiency | 計測データ不備 | 可 | check_measurement_deficiency |

## テスト

テストスクリプト `test_error_handling.py` を実行すると、すべての機能をテストできます:

```bash
python3 test_error_handling.py
```

テスト内容:
- ValidationError クラスの動作確認
- 各エラーチェック関数の動作確認
- エラー確認ステータスの保存と復元
- 計測データ不備チェック

## 注意事項

1. **アプリ再起動**: 確認済みステータスはアプリ再起動でリセットされます
2. **データ修正**: エラーを修正してデータを再読み込みすると、同一エラーの確認済みステータスが復元されます
3. **重大エラー**: CSVファイル名重複とゼッケン重複は必ず修正してください
4. **計測データ不備**: 計算実行後にのみチェックされます

## 今後の拡張

以下の機能拡張が考えられます:

1. エラー確認状態のファイル保存（再起動後も保持）
2. エラーフィルタリング機能（未確認のみ表示など）
3. エラーのエクスポート機能（CSV出力など）
4. エラー統計情報の表示
