# データ検証機能ガイド

## 概要

PC-System-Tool に追加されたデータ検証機能は、レースデータの整合性をチェックし、不正データや潜在的なエラーを早期に発見します。

---

## 検証機能一覧

### 1. CSVファイル名重複チェック 🔍

**目的:**
同じ区間名を持つファイルが複数存在しないかチェックします。

**検出される問題:**
- 例: `PC3GOAL.csv` と `PC3GOAL_PC4START.csv` が同じフォルダに存在
- ファイル名から抽出した区間名が重複している場合

**エラーメッセージ例:**
```
⚠️ CSVファイル名重複エラー
区間 'PC3GOAL' が複数のファイルに存在します:
  - PC3GOAL.csv
  - PC3GOAL_PC4START.csv
ファイル名を修正してください。
```

**対処方法:**
1. どちらかのファイル名を変更
2. または不要なファイルを削除
3. ファイル名の命名規則を確認

---

### 2. ゼッケン重複チェック 🔢

**目的:**
同じ区間に同じゼッケンが2回以上出現しないかチェックします。

**検出される問題:**
- 同じCSVファイル内に同じゼッケンが複数行存在
- データ入力ミスや重複登録

**エラーメッセージ例:**
```
⚠️ ゼッケン重複エラー
区間 'PC1' でゼッケン 5 が2回出現しています。
CSVファイルを確認してください。
```

**対処方法:**
1. 該当するCSVファイルを開く
2. 重複しているゼッケンの行を確認
3. 不要な行を削除、または正しいデータに修正

---

### 3. 区間通過順チェック 📊

**目的:**
同じグループ内の各区間で、ゼッケンの通過順序が一致するかチェックします。

**検証ロジック:**
- グループの最初の区間を基準とする
- 他の区間の通過順序と比較
- 順序の不一致、歯抜け、追加ゼッケンを検出

**検出される問題:**
- **順序の不一致**: 基準区間と異なる順序で通過
- **歯抜け**: 基準区間にあるが、他の区間にない
- **追加**: 基準区間にないが、他の区間にある

**エラーメッセージ例:**

**順序不一致:**
```
⚠️ 区間通過順エラー
グループ 1 で通過順序が異なります:
  基準区間 PC1: [1, 2, 3, 5, 10]
  区間 PC2: [1, 2, 5, 3, 10]  ← 順序が異なる
確認してください。
```

**歯抜け:**
```
⚠️ 区間通過順エラー（歯抜け）
グループ 1 の区間 PC2 で、
基準区間 PC1 にあるゼッケンが欠けています: [3, 5]
確認してください。
```

**追加:**
```
⚠️ 区間通過順エラー（追加）
グループ 1 の区間 PC2 で、
基準区間 PC1 にないゼッケンがあります: [15, 20]
確認してください。
```

**対処方法:**
1. 基準区間と他の区間のデータを比較
2. データ入力ミスを確認
3. 実際の通過順序を確認
4. 必要に応じてCSVファイルを修正

---

### 4. ゼッケン通過順チェック 🚗

**目的:**
各ゼッケンがグループ内の区間を正しい順序で通過しているかチェックします。

**検証ロジック:**
- 区間の正しい順序を取得（section設定ファイルから）
- 各ゼッケンの実際の通過順序と比較
- 順序が異なる場合にエラー

**検出される問題:**
- 例: PC1 → PC2 → PC4 → PC3（PC3とPC4が逆）
- 区間をスキップして通過
- 区間の順序が間違っている

**エラーメッセージ例:**
```
⚠️ ゼッケン通過順エラー
ゼッケン 5 がグループ 1 で不正な順序で通過:
  期待: PC1 → PC2 → PC3 → PC4
  実際: PC1 → PC2 → PC4 → PC3
確認してください。
```

**対処方法:**
1. 該当するゼッケンのデータを確認
2. 実際の通過順序を確認
3. データ入力ミスがあれば修正
4. 必要に応じてCSVファイル名や内容を修正

---

### 5. ステータス不正チェック ⚠️

**目的:**
RIT（リタイヤ）または BLNK（ブランク）ステータスのゼッケンが、走行データ（START時刻/GOAL時刻）を持っていないかチェックします。

**検証ロジック:**
- RIT/BLNKステータスを持つ結果を検索
- START時刻またはGOAL時刻が存在するかチェック
- 存在する場合はエラー（矛盾）

**検出される問題:**
- RITステータスなのに走行データがある
- BLNKステータスなのに走行データがある
- ステータス設定ミス

**エラーメッセージ例:**
```
⚠️ ステータス不正エラー
区間 'PC2' でゼッケン 8 は RIT ステータスですが、
START時刻とGOAL時刻の両方が存在します。
確認してください。
```

**対処方法:**
1. ステータス設定が正しいか確認
2. 走行データが正しいか確認
3. どちらかを修正:
   - ステータスを削除（走行した場合）
   - 走行データを削除（本当にRIT/BLNKの場合）

---

## UI表示

### エラー表示エリア

**配置:**
- 画面最上部に表示
- エラーがある場合のみ表示

**デザイン:**
- 背景色: 淡い黄色（#FFF9E6）
- テキスト色: 赤色（#D32F2F）
- 枠線: オレンジ色（#FFB74D）
- 太字フォント

**表示内容:**
```
⚠️ エラー・警告が検出されました:

1. ⚠️ CSVファイル名重複エラー
   区間 'PC3GOAL' が複数のファイルに存在します:
   ...

2. ⚠️ ゼッケン重複エラー
   区間 'PC1' でゼッケン 5 が2回出現しています。
   ...
```

**スクロール:**
- エラーが多い場合はスクロール可能
- 最大高さ: 120px

---

## 使用フロー

### 1. Race読み込み時

```
[② Race読み込み] クリック
  ↓
CSVファイル読み込み
  ↓
データ解析
  ↓
【データ検証実行】 ← ここで5つの検証を実行
  ↓
エラー検出
  ↓
エラー表示エリアに表示（エラーがある場合）
  ↓
ログに概要を表示
```

### 2. 計算実行時

```
[③ 計算実行] クリック
  ↓
エラーがあるかチェック
  ↓
【エラーあり】
  ↓
確認ダイアログ表示:
「データ検証でエラー/警告が検出されています。
 計算を続行しますか？」
  ↓
[はい] → 計算続行
[いいえ] → 計算中止、エラー修正を促す
```

---

## トラブルシューティング

### Q1: エラーが表示されたらどうすればいい？

**A:** 
1. エラーメッセージをよく読む
2. 該当するCSVファイルを開く
3. エラー内容に従って修正
4. Race読み込みを再実行
5. エラーが消えたことを確認

### Q2: エラーがあっても計算できる？

**A:** 
できますが、推奨しません。エラーがある状態で計算すると、結果が不正確になる可能性があります。できる限りエラーを修正してから計算してください。

### Q3: エラーメッセージが長くて全部見えない

**A:** 
エラー表示エリアはスクロール可能です。マウスホイールやスクロールバーで全内容を確認できます。

### Q4: エラーを無視したい場合は？

**A:** 
計算実行時の確認ダイアログで「はい」を選択すれば、エラーがあっても計算を続行できます。ただし、データの整合性は保証されません。

### Q5: どの検証でエラーが出やすい？

**A:** 
経験上、以下の順で多いです:
1. 区間通過順チェック（歯抜けや追加）
2. ゼッケン通過順チェック
3. ステータス不正チェック
4. ゼッケン重複チェック
5. CSVファイル名重複チェック

---

## 技術詳細

### データ検証の実行タイミング

**Race読み込み後:**
```python
validation_errors = validate_all(
    race_folder,
    results,
    sections
)
```

**検証項目:**
1. check_duplicate_filenames(race_folder)
2. check_duplicate_zekken_in_section(results)
3. check_section_passage_order(results, sections)
4. check_zekken_passage_order(results, sections)
5. check_invalid_status_with_time(results)

### エラーメッセージのフォーマット

各検証メソッドは `List[str]` を返します:
- 各要素が1つのエラーメッセージ
- 改行を含む詳細なメッセージ
- UIで整形して表示

---

## ベストプラクティス

### 1. 定期的な検証

Race読み込み後、必ずエラー表示エリアを確認してください。

### 2. エラー修正の優先順位

1. **高**: ゼッケン重複、CSVファイル名重複
2. **中**: ステータス不正
3. **低**: 区間通過順、ゼッケン通過順（確認が必要だが、正当な理由がある場合もある）

### 3. データ入力時の注意

- CSVファイル名は明確に
- 同じゼッケンを複数回入力しない
- ステータス設定と走行データの整合性を保つ
- 区間の通過順序を確認

---

## まとめ

データ検証機能により、以下が可能になりました:

✅ **早期発見** - エラーを計算前に発見  
✅ **明確な指示** - 何を修正すればいいか明確  
✅ **データ品質向上** - 不正データの混入を防ぐ  
✅ **時間短縮** - 計算後のやり直しを防ぐ  
✅ **信頼性向上** - データの整合性を保証  

エラーが検出された場合は、焦らず一つずつ対処してください。
